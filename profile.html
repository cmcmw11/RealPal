<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ ğŸ’œ</title>
<link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/style.css"> <!-- à¹ƒà¸Šà¹‰ CSS à¸£à¸§à¸¡ -->
</head>
<body>

<header>à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ ğŸ’œ</header>

<main>
  <div class="profile-header">
    <img src="" id="profileAvatar" class="avatar-large">
    <div class="profile-info">
      <h2 id="profileName"></h2>
      <p>à¸Šà¸·à¹ˆà¸­à¸­à¸§à¸²à¸•à¸²à¸£à¹Œ: <span id="profileAvatarName">-</span></p>
      <p>à¹€à¸à¸·à¹ˆà¸­à¸™: <span id="friendCount">0</span> à¸„à¸™</p>
    </div>
    <button class="edit-btn" onclick="openEditModal()">à¹à¸à¹‰à¹„à¸‚</button>
  </div>

  <div id="userPosts"></div>
</main>

<!-- Modal à¹à¸à¹‰à¹„à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ -->
<div id="editProfileModal">
  <form id="editProfileForm">
    <h3>à¹à¸à¹‰à¹„à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ</h3>
    <div style="text-align:center; margin-bottom:12px;">
      <img id="editAvatarPreview" src="">
      <input type="file" id="editAvatarUpload" accept="image/*">
    </div>
    <input type="text" id="editRealName" placeholder="à¸Šà¸·à¹ˆà¸­à¸ˆà¸£à¸´à¸‡" required>
    <input type="text" id="editAvatarName" placeholder="à¸Šà¸·à¹ˆà¸­à¸­à¸§à¸²à¸•à¸²à¸£à¹Œ">
    <button type="submit">à¸šà¸±à¸™à¸—à¸¶à¸</button>
    <button type="button" onclick="closeEditModal()">à¸¢à¸à¹€à¸¥à¸´à¸</button>
  </form>
</div>

<footer>
  <button onclick="goTo('index.html')">ğŸ </button>
  <button onclick="goTo('chat.html')">ğŸ’¬</button>
  <button onclick="goTo('profile.html')">ğŸ§‘</button>
  <button onclick="goTo('friendsearch.html')">ğŸ§‘â€ğŸ¤â€ğŸ§‘</button>
</footer>

<script type="module">
import { loadProfile, loadPosts, updateProfile } from "./js/profile.js";
import { uploadProfile } from "./js/storage.js";

const currentUserId = localStorage.getItem("currentUserId");
if(!currentUserId){
  alert("âŒ à¸à¸£à¸¸à¸“à¸²à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸à¹ˆà¸­à¸™");
  window.location.href = "login.html";
}

const profileAvatar = document.getElementById('profileAvatar');
const profileName = document.getElementById('profileName');
const profileAvatarName = document.getElementById('profileAvatarName');
const friendCount = document.getElementById('friendCount');
const userPosts = document.getElementById('userPosts');

const editModal = document.getElementById('editProfileModal');
const editAvatarPreview = document.getElementById('editAvatarPreview');
let newProfileFile = null;

window.openEditModal = function(){
  editModal.style.display='flex';
  editAvatarPreview.src = profileAvatar.src;
  document.getElementById('editRealName').value = profileName.textContent;
  document.getElementById('editAvatarName').value = profileAvatarName.textContent==='-'?'':profileAvatarName.textContent;
}
window.closeEditModal = function(){ editModal.style.display='none'; }

document.getElementById('editAvatarUpload').addEventListener('change',(e)=>{
  newProfileFile = e.target.files[0];
  if(newProfileFile){
    const reader = new FileReader();
    reader.onload = ()=> editAvatarPreview.src = reader.result;
    reader.readAsDataURL(newProfileFile);
  }
});

// submit form à¹à¸à¹‰à¹„à¸‚à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ
document.getElementById('editProfileForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const newName = document.getElementById('editRealName').value.trim();
  const newAvatarName = document.getElementById('editAvatarName').value.trim();
  let newAvatarURL = profileAvatar.src;

  try{
    if(newProfileFile){
      newAvatarURL = await uploadProfile(currentUserId,newProfileFile);
    }

    await updateProfile({realName:newName, avatarName:newAvatarName, avatar:newAvatarURL});

    profileAvatar.src = newAvatarURL;
    profileName.textContent = newName;
    profileAvatarName.textContent = newAvatarName || '-';
    alert("à¸­à¸±à¸›à¹€à¸”à¸•à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢ ğŸ’œ");
    closeEditModal();
  }catch(err){
    alert("âŒ "+err.message);
  }
});

window.goTo = function(page){ window.location.href=page; }

// à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸­à¸™à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
(async ()=>{
  await loadProfile().then(data=>{
    profileAvatar.src = data.avatar || 'https://via.placeholder.com/60';
    profileName.textContent = data.realName || '-';
    profileAvatarName.textContent = data.avatarName || '-';
    friendCount.textContent = data.friends?.length || 0;
  });

  await loadPosts().then(posts=>{
    userPosts.innerHTML='';
    posts.forEach(data=>{
      if(data.userId !== currentUserId) return;
      const postDiv = document.createElement('div');
      postDiv.className='post';
      postDiv.innerHTML=`
        <div class="author">${data.realName}</div>
        <div class="content">${data.content || ''}${data.imageUrl? `<br><img src="${data.imageUrl}" style="max-width:100%;">` : ''}</div>
        ${data.repostFrom? `<div class="repost">ğŸ” à¸£à¸µà¹‚à¸à¸ªà¸•à¹Œà¸ˆà¸²à¸ ${data.repostFrom}</div>` : ''}
      `;
      userPosts.appendChild(postDiv);
    });
  });
})();
</script>

</body>
</html>

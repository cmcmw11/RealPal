<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÅ‡∏ä‡∏ó üíú</title>
<link href="https://fonts.googleapis.com/css2?family=Mali:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --blue:#a5c9ff; --purple:#d6b8ff; --white:#fff; --bg:#f5f7ff;
  --text:#333; --shadow:0 4px 10px rgba(0,0,0,0.05); --radius:18px;
}
body{
  font-family:'Mali',sans-serif; margin:0; background:var(--bg); max-width:430px; margin:0 auto;
}
header{
  background:linear-gradient(90deg,var(--blue),var(--purple));
  color:white; text-align:center; padding:12px 0; font-weight:600;
  border-bottom-left-radius:var(--radius); border-bottom-right-radius:var(--radius);
}
.friends-box, .chat-box{
  background:var(--white); margin:12px; padding:12px; border-radius:var(--radius); box-shadow:var(--shadow);
}
.friends-box ul, .messages{list-style:none; padding:0; margin:0;}
.friends-box li, .messages li{padding:6px; border-radius:12px; margin:4px 0; display:flex; align-items:center;}
.friends-box li{background:#f0f0ff; cursor:pointer;}
.friends-box li img, .messages li img{width:40px; height:40px; border-radius:50%; margin-right:8px;}
.messages li.self{justify-content:flex-end; background:#d6b8ff;}
.messages li.other{justify-content:flex-start; background:#a5c9ff;}
.chat-input{display:flex; margin-top:8px;}
.chat-input input{flex:1; padding:8px; border-radius:12px; border:1px solid #ddd;}
.chat-input button{padding:8px 12px; margin-left:4px; border:none; border-radius:12px; background:linear-gradient(135deg,var(--purple),var(--blue)); color:white; cursor:pointer;}
.call-btn{margin-top:8px; width:100%; background:#ffa5a5;}
</style>
</head>
<body>

<header>‡πÅ‡∏ä‡∏ó üíú</header>

<div class="friends-box">
  <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</h3>
  <ul id="friendsList"></ul>
</div>

<div class="chat-box" style="display:none;">
  <h3 id="chatWith">‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö...</h3>
  <ul class="messages" id="messages"></ul>
  <div class="chat-input">
    <input type="text" id="msgInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°...">
    <button id="sendBtn">‡∏™‡πà‡∏á</button>
  </div>
  <button class="call-btn" id="callBtn">üìπ ‡πÇ‡∏ó‡∏£‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
</div>

<script type="module">
import { loadFriends } from "./js/profile.js";
import { sendMessage, listenMessages, startCall } from "./js/chat.js";

let currentChatId = null;

async function initFriends(){
  const friends = await loadFriends();
  const ul = document.getElementById("friendsList");
  ul.innerHTML = "";
  friends.forEach(f=>{
    const li = document.createElement("li");
    li.innerHTML = `<img src="realpal/avatar1.png" alt="avatar"><span>${f}</span>`;
    li.addEventListener("click", ()=> openChat(f));
    ul.appendChild(li);
  });
}

function openChat(friendId){
  currentChatId = [friendId, localStorage.getItem("currentUserId")].sort().join("_"); // chatId unique
  document.getElementById("chatWith").textContent = `‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö ${friendId}`;
  document.querySelector(".chat-box").style.display = "block";

  // ‡∏ü‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
  listenMessages(currentChatId, messages=>{
    const ul = document.getElementById("messages");
    ul.innerHTML = "";
    messages.forEach(m=>{
      const li = document.createElement("li");
      li.className = m.senderId===localStorage.getItem("currentUserId") ? "self" : "other";
      li.innerHTML = `<img src="${m.avatar}" alt="avatar"><span>${m.text}</span>`;
      ul.appendChild(li);
    });
    ul.scrollTop = ul.scrollHeight;
  });
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
document.getElementById("sendBtn").addEventListener("click", async ()=>{
  const text = document.getElementById("msgInput").value.trim();
  if(!text || !currentChatId) return;
  await sendMessage(currentChatId, text);
  document.getElementById("msgInput").value="";
});

// ‡πÇ‡∏ó‡∏£‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
document.getElementById("callBtn").addEventListener("click", ()=>{
  if(!currentChatId) return;
  const peerId = currentChatId.replace(localStorage.getItem("currentUserId")+"_","");
  startCall(peerId,"video");
});

initFriends();
</script>

</body>
</html>
